<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive finger light show with dark theme">
    <title>Finger Light Show | Client-Side</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
        /* CSS එකත් මෙතනම දානවා, static file එකක් ඕන නැත්නම් */
        /* ඔයාගෙ style.css එකේ content එක මෙතන paste කරන්න */
        /* ... Your style.css content goes here ... */

        /* Video/Canvas එක හරියට පෙන්නන්න පොඩි style එකක් */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 640px; /* Video width */
            margin: auto;
            border-radius: 8px;
            overflow: hidden;
            background: #111;
        }
        #output_canvas {
            width: 100%;
            height: auto;
            transform: scaleX(-1); /* Mirror view */
        }
        #webcam {
            display: none; /* Hide the raw video, we only show the canvas */
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo">
                <svg class="logo-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2V4M12 20V22M4 12H2M6.31412 6.31412L4.8999 4.8999M17.6859 6.31412L19.1001 4.8999M6.31412 17.69L4.8999 19.1042M17.6859 17.69L19.1001 19.1042M21 12H23M16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="glow-text">FINGER LIGHT SHOW</span>
            </div>
            <p class="tagline">Control the lights with your fingers in real-time</p>
        </header>

        <div class="main-grid">
            <div class="panel">
                <h2 class="section-title">
                    CAMERA FEED
                </h2>
                <div class="video-container">
                    <video id="webcam"></video> 
                    <canvas id="output_canvas" width="640px" height="480px"></canvas>
                </div>
                <div class="status-display">
                    <div class="status-card">
                        <div class="status-title">FINGERS DETECTED</div>
                        <div class="status-value" id="fingerCount">0</div>
                    </div>
                    <div class="status-card">
                        <div class="status-title">LIGHTS ACTIVE</div>
                        <div class="status-value" id="activeLights">0</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2 class="section-title">
                    LIGHT CONTROLS
                </h2>
                <div class="controls-container">
                    <div class="light-grid">
                        <div class="light-bulb"><div class="bulb" id="bulb1"></div><span class="bulb-label">LIGHT 1</span></div>
                        <div class="light-bulb"><div class="bulb" id="bulb2"></div><span class="bulb-label">LIGHT 2</span></div>
                        <div class="light-bulb"><div class="bulb" id="bulb3"></div><span class="bulb-label">LIGHT 3</span></div>
                        <div class="light-bulb"><div class="bulb" id="bulb4"></div><span class="bulb-label">LIGHT 4</span></div>
                        <div class="light-bulb"><div class="bulb" id="bulb5"></div><span class="bulb-label">LIGHT 5</span></div>
                    </div>
                    <h2 class="section-title">
                        HOW TO USE
                    </h2>
                    <ul class="instructions-list">
                        <li>Position your hand in front of your camera</li>
                        <li>Raise fingers to activate corresponding lights</li>
                        <li>1 finger = Light 1, 2 fingers = Lights 1 & 2, etc.</li>
                        <li>Keep your hand steady for best detection</li>
                    </ul>
                    <div class="connection-status">
                        <div class="connection-dot" id="connectionDot"></div>
                        <div class="connection-text" id="connectionStatus">INITIALIZING...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', function() {
            
            // DOM elements
            const videoElement = document.getElementById('webcam');
            const canvasElement = document.getElementById('output_canvas');
            const canvasCtx = canvasElement.getContext('2d');
            const fingerCountDisplay = document.getElementById('fingerCount');
            const activeLightsDisplay = document.getElementById('activeLights');
            const connectionDot = document.getElementById('connectionDot');
            const connectionStatus = document.getElementById('connectionStatus');
            
            // Initialize light bulbs
            const lightBulbs = [];
            for (let i = 1; i <= 5; i++) {
                lightBulbs.push(document.getElementById(`bulb${i}`));
            }

            // --- Finger Counting Logic (Python වලින් JS වලට port කරපු එක) ---
            const TIP_IDS = [4, 8, 12, 16, 20];
            const BASE_IDS = [3, 6, 10, 14, 18]; // Using MCP for fingers, IP for thumb

            function countFingers(handLandmarks) {
                let fingers = 0;
                
                // Y-coordinate: 0 is top, 1 is bottom. 
                // So, if tip.y < base.y, the finger is "up".
                
                // Thumb (Special logic: check Y coordinate)
                // Note: User's Python code had a simple Y check. We'll replicate that.
                if (handLandmarks[TIP_IDS[0]].y < handLandmarks[BASE_IDS[0]].y) {
                    fingers++;
                }

                // Other 4 fingers
                for (let i = 1; i < 5; i++) {
                    if (handLandmarks[TIP_IDS[i]].y < handLandmarks[BASE_IDS[i]].y) {
                        fingers++;
                    }
                }
                return fingers;
            }

            // --- UI Update Function ---
            function updateUI(count) {
                fingerCountDisplay.textContent = count;
                activeLightsDisplay.textContent = count;

                // Update light bulbs
                lightBulbs.forEach((bulb, index) => {
                    if (index < count) {
                        bulb.classList.add('lit');
                    } else {
                        bulb.classList.remove('lit');
                    }
                });
            }

            // --- MediaPipe Hands Setup ---
            const hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });

            hands.setOptions({
                maxNumHands: 1, // එක අතක් detect කරන්න
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            // --- Main Processing Function ---
            function onResults(results) {
                canvasCtx.save();
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

                let fingerCount = 0;
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    // එක අතක් විතරක් පාවිච්චි කරන නිසා [0]
                    const handLandmarks = results.multiHandLandmarks[0];
                    
                    // Draw landmarks
                    drawConnectors(canvasCtx, handLandmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                    drawLandmarks(canvasCtx, handLandmarks, {color: '#FF0000', lineWidth: 2});

                    // Count fingers
                    fingerCount = countFingers(handLandmarks);
                }
                
                // Update the UI
                updateUI(fingerCount);
                
                canvasCtx.restore();
            }

            hands.onResults(onResults);

            // --- Camera Setup ---
            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 640,
                height: 480
            });
            
            // Start camera and update status
            camera.start()
                .then(() => {
                    connectionStatus.textContent = 'CAMERA ACTIVE';
                    connectionDot.classList.add('connected');
                })
                .catch((e) => {
                    console.error("Camera Error:", e);
                    connectionStatus.textContent = 'CAMERA ERROR';
                    connectionDot.classList.remove('connected');
                });
            
            updateUI(0); // Initialize UI
        });
    </script>
</body>
</html>